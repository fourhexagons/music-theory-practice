<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Theory Practice - Test Suite</title>
    <link rel="stylesheet" href="css/test-suite.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test Suite</h1>
            <p>Comprehensive testing tools for the Music Theory Practice application</p>
        </div>
        
        <a href="../index.html" class="back-link">‚Üê Back to Main App</a>
        
        <!-- Test Status Dashboard -->
        <div class="test-category">
            <h2>üìä Test Status Dashboard</h2>
            <p>Overview of last test run results across all test suites</p>
            <div id="test-dashboard" class="dashboard-container">
                <div class="dashboard-summary">
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="total-tests">-</span>
                            <span class="stat-label">Total Tests</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="passed-tests">-</span>
                            <span class="stat-label">Passed</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="failed-tests">-</span>
                            <span class="stat-label">Failed</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="success-rate">-</span>
                            <span class="stat-label">Success Rate</span>
                        </div>
                    </div>
                    <div class="dashboard-actions">
                        <button onclick="runAllTests()" class="btn">Run All Tests</button>
                        <button onclick="clearTestHistory()" class="btn btn-secondary">Clear History</button>
                        <span id="last-updated-status" class="last-updated"></span>
                    </div>
                </div>
                <div id="test-status-grid" class="test-status-grid">
                    <!-- Test status cards will be populated here -->
                </div>
            </div>
        </div>
        
        <div class="test-category">
            <h2>üéØ Core Application Tests</h2>
            <p>Essential functionality that must work for the app to function</p>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Learning Path <span id="status-learning-path" class="status-icon" title="Test status"></span></h3>
                    <p>Simulates complete learning path to verify progression logic, level advancement, and question cycling.</p>
                    <a href="test_learning_path.html" class="test-link">Run Test</a>
                </div>
                
                <div class="test-card">
                    <h3>Core Logic <span id="status-core-logic" class="status-icon" title="Test status"></span></h3>
                    <p>Tests state management, question generation, answer validation, and learning progression logic.</p>
                    <a href="test_app_logic.html" class="test-link">Run Test</a>
                </div>
                
                <div class="test-card">
                    <h3>Chord Normalization <span id="status-chord-normalization" class="status-icon" title="Test status"></span></h3>
                    <p>Tests chord normalization logic for various input formats including M7 notation, halfdim text, and double accidentals.</p>
                    <a href="test_chords.html" class="test-link">Run Test</a>
                </div>
            </div>
        </div>
        
        <div class="test-category">
            <h2>üéµ Music Theory Validation</h2>
            <p>Domain-specific tests for music theory accuracy and data integrity</p>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Seventh Chords <span id="status-seventh-chords" class="status-icon" title="Test status"></span></h3>
                    <p>Tests seventh chord identification, spelling, and validation across different keys and chord types.</p>
                    <a href="test_sevenths.html" class="test-link">Run Test</a>
                </div>
                <div class="test-card">
                    <h3>Validation, Errors & Edges <span id="status-validation-edges" class="status-icon" title="Test status"></span></h3>
                    <p>Unified suite for normalization, answer validation, error handling, and edge cases. All tests use the real app logic.</p>
                    <a href="test_validation_and_errors.html" class="test-link">Run Test</a>
                </div>
            </div>
                </div>
                
        <div class="test-category">
            <h2>üîç Data & Integrity Tests</h2>
            <p>Ensures data quality, consistency, and system reliability</p>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Data Integrity <span id="status-data-integrity" class="status-icon" title="Test status"></span></h3>
                    <p>Tests for quiz data completeness, consistency, and relationship validation across all keys and degrees.</p>
                    <a href="test_data_integrity.html" class="test-link">Run Test</a>
                </div>
            </div>
        </div>
        
        <div class="test-category">
            <h2>üõ†Ô∏è Development Tools</h2>
            <p>Interactive debugging and development aids</p>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Debug Normalize <span id="status-debug-normalize" class="status-icon" title="Tool status"></span></h3>
                    <p>Interactive testing of chord normalization function with live input/output for development and troubleshooting.</p>
                    <a href="debug_normalization.html" class="test-link">Open Tool</a>
                </div>
            </div>
        </div>
        
        <!-- Modal for suite details (placeholder) -->
        <div id="suite-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeSuiteModal()">&times;</span>
                <h3 id="modal-suite-name"></h3>
                <p id="modal-suite-description"></p>
                <button id="modal-run-test" class="btn">Run Test</button>
                <span id="modal-suite-badge" class="test-status"></span>
                <div id="modal-recent-results"></div>
            </div>
        </div>
        <div class="footer">
            <p><strong>Test Coverage:</strong> 8 test suites covering core functionality, music theory validation, data integrity, and development tools.</p>
            <p><strong>Last updated:</strong> <span id="last-updated"></span></p>
        </div>
    </div>
    
    <script src="js/test-dashboard.js"></script>
    <script>
        // Test Status Dashboard System
        const TEST_SUITES = {
            'test_learning_path.html': {
                name: 'Learning Path',
                category: 'Core Application',
                description: 'Simulates complete learning path progression'
            },
            'test_app_logic.html': {
                name: 'Core Logic',
                category: 'Core Application',
                description: 'Tests state management and core logic'
            },
            'test_chords.html': {
                name: 'Chord Normalization',
                category: 'Core Application',
                description: 'Tests chord normalization logic'
            },
            'test_sevenths.html': {
                name: 'Seventh Chords',
                category: 'Music Theory',
                description: 'Tests seventh chord validation'
            },
            'test_validation_and_errors.html': {
                name: 'Validation, Errors & Edges',
                category: 'Music Theory',
                description: 'Unified suite for normalization, answer validation, error handling, and edge cases'
            },
            'test_data_integrity.html': {
                name: 'Data Integrity',
                category: 'Data & Integrity',
                description: 'Tests data completeness and consistency'
            },
            'debug_normalization.html': {
                name: 'Debug Normalize',
                category: 'Development Tools',
                description: 'Interactive debugging tool'
            }
        };

        function runAllTests() {
            const testFiles = Object.keys(TEST_SUITES).filter(
                file => TEST_SUITES[file].category !== 'Development Tools'
            );
            
            const userConfirmed = confirm(
                `This will open ${testFiles.length} test suites in new tabs. ` +
                `Please ensure your browser allows pop-ups for this site.\n\n` +
                `Do you want to proceed?`
            );

            if (userConfirmed) {
                testFiles.forEach((file, index) => {
                    setTimeout(() => {
                        window.open(file, '_blank');
                    }, index * 200); // Stagger opening new tabs
                });
                alert('Running all tests... Please check the new tabs that have been opened.');
            }
        }

        function clearTestHistory() {
            const userConfirmed = confirm(
                `Are you sure you want to clear the entire test history? ` +
                `This action cannot be undone.`
            );
            if (userConfirmed) {
                window.TestDashboard.clearTestHistory();
                updateDashboard(); // Refresh the view immediately
                alert('Test history has been cleared.');
            }
        }

        function updateDashboard() {
            const testHistory = window.TestDashboard.getTestResults();
            const statusGrid = document.getElementById('test-status-grid');
            
            // Clear existing status cards
            statusGrid.innerHTML = '';
            
            let totalTests = 0;
            let totalPassed = 0;
            let totalFailed = 0;
            
            // Create status cards for each test suite
            Object.entries(TEST_SUITES).forEach(([testFile, testInfo]) => {
                const result = testHistory[testFile];
                const statusCard = createStatusCard(testFile, testInfo, result);
                statusGrid.appendChild(statusCard);
                
                if (result) {
                    totalTests += result.total || 0;
                    totalPassed += result.passed || 0;
                    totalFailed += result.failed || 0;
                }
            });
            
            // Update summary stats
            const successRate = totalTests > 0 ? ((totalPassed / totalTests) * 100).toFixed(0) : '-';
            document.getElementById('total-tests').textContent = totalTests;
            document.getElementById('passed-tests').textContent = totalPassed;
            document.getElementById('failed-tests').textContent = totalFailed;
            document.getElementById('success-rate').textContent = successRate !== '-' ? `${successRate}%` : '-';
            
            // Update last updated timestamp
            const lastUpdatedElement = document.getElementById('last-updated-status');
            const timestamps = Object.values(testHistory).map(r => new Date(r.timestamp));
            if (timestamps.length > 0) {
                const lastUpdated = new Date(Math.max.apply(null, timestamps));
                lastUpdatedElement.textContent = `Last run: ${lastUpdated.toLocaleString()}`;
            } else {
                lastUpdatedElement.textContent = 'No test history';
            }
            
            // Update status icons
            updateSimpleStatusIcons(testHistory);
        }

        function updateSimpleStatusIcons(testHistory) {
            // Map test files to their actual HTML element IDs
            const idMapping = {
                'test_learning_path.html': 'status-learning-path',
                'test_app_logic.html': 'status-core-logic',
                'test_chords.html': 'status-chord-normalization',
                'test_sevenths.html': 'status-seventh-chords',
                'test_validation_and_errors.html': 'status-validation-edges',
                'test_data_integrity.html': 'status-data-integrity',
                'debug_normalization.html': 'status-debug-normalize'
            };

            Object.entries(TEST_SUITES).forEach(([testFile, suiteInfo]) => {
                const iconId = idMapping[testFile];
                const iconElement = document.getElementById(iconId);

                if (iconElement) {
                    const result = testHistory[testFile];
                    let statusClass = 'status-icon'; // Default: not-run
                    let title = 'Not run yet';

                    if (result) {
                        if (result.failed > 0) {
                            statusClass += ' fail';
                        } else if (result.passed > 0) {
                            statusClass += ' pass';
                        }
                        const passRate = result.total > 0 ? Math.round((result.passed / result.total) * 100) : 0;
                        title = `${result.passed}/${result.total} passed (${passRate}%) - ${result.lastRun}`;
                    }
                    iconElement.className = statusClass;
                    iconElement.title = title;
                }
            });
        }
        
        function createStatusCard(testFile, testInfo, result) {
            const card = document.createElement('div');
            card.className = 'test-status-card unified';

            const status = result ? (result.failed === 0 ? 'passed' : 'failed') : 'not-run';
            const statusText = result ? `${result.passed}/${result.total} passed` : 'Not run';
            const lastRun = result ? result.lastRun : 'Never';

            card.innerHTML = `
                <div class="card-header">
                    <h4 class="suite-title">${testInfo.name}</h4>
                    <div class="status-indicator ${status}"></div>
                </div>
                <div class="suite-stats">${statusText}</div>
                <div class="suite-last-run">Last run: ${lastRun}</div>
                <button class="btn run-btn" onclick="window.open('${testFile}', '_blank'); event.stopPropagation();">Run Test</button>
            `;
            card.style.cursor = 'default';
            return card;
        }

        // Modal logic
        function openSuiteModal(testFile, testInfo, result) {
            console.log('openSuiteModal called for', testFile);
            document.getElementById('modal-suite-name').textContent = testInfo.name;
            document.getElementById('modal-suite-description').textContent = testInfo.description;
            const badge = document.getElementById('modal-suite-badge');
            badge.textContent = (testInfo.category === 'Development Tools') ? 'Development Tool' : 'Production Ready';
            badge.className = 'test-status ' + ((testInfo.category === 'Development Tools') ? 'status-dev' : 'status-production');
            // Run Test button
            const runBtn = document.getElementById('modal-run-test');
            runBtn.onclick = () => window.open(testFile, '_blank');
            // Recent results (placeholder)
            const recentDiv = document.getElementById('modal-recent-results');
            if (result) {
                recentDiv.innerHTML = `<p><strong>Last Run:</strong> ${result.lastRun}<br><strong>Passed:</strong> ${result.passed}/${result.total}<br><strong>Success Rate:</strong> ${result.successRate || '-'}%</p>`;
            } else {
                recentDiv.innerHTML = '<p>No recent results.</p>';
            }
            document.getElementById('suite-modal').classList.add('show');
        }
        function closeSuiteModal() {
            document.getElementById('suite-modal').classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();

            // Also update the main footer last updated time
            const lastUpdatedFooter = document.getElementById('last-updated');
            if (lastUpdatedFooter) {
                lastUpdatedFooter.textContent = new Date().toLocaleString();
            }

            // Set up a listener to refresh the dashboard if tests are run in other tabs
            window.addEventListener('storage', (event) => {
                if (event.key === 'testHistory') {
                    console.log('Test history updated in another tab. Refreshing dashboard...');
                    updateDashboard();
                }
            });
        });
    </script>
</body>
</html> 