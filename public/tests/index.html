<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Music Theory Practice – Comprehensive Test Suite</title>
    <link rel="stylesheet" href="css/test-suite.css">
    <style>
        .test-result {
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid;
            word-break: break-word;
            overflow-wrap: anywhere;
        }
        .test-result.pass {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .test-result.fail {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .status {
            font-weight: bold;
        }
        .test-details {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin: 4px 0;
        }
        .category-header {
            background-color: #e9ecef;
            padding: 10px;
            margin: 20px 0 10px 0;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .test-controls .btn {
            flex: 1;
            min-width: 150px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .progress-fill.complete {
            background-color: #28a745;
        }
        .progress-fill.error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 Music Theory Practice – Comprehensive Test Suite</h1>
            <p>Complete test coverage for all app functionality. Run all tests in one place.</p>
        </div>
        <div class="content-box">
            <div id="summary" class="summary" style="display:none;">
                <div id="summary-content"></div>
            </div>
            <div class="test-controls">
                <button class="btn" onclick="runAllTests()">Run All Tests</button>
                <button class="btn" onclick="runCoreTests()">Core Logic Only</button>
                <button class="btn" onclick="runDataTests()">Data & Validation Only</button>
                <button class="btn" onclick="runUITests()">UI & Integration Only</button>
                <button class="btn" onclick="runAdvancedTests()">Advanced Features Only</button>
                <button class="btn" onclick="runPerformanceTests()">Performance Only</button>
                <button class="btn" onclick="copyResults()">Copy Results (JSON)</button>
                <button class="btn" onclick="clearResults()">Clear Results</button>
            </div>
            <div id="progress-container" style="display:none;">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progress-text">Ready to run tests...</div>
            </div>
            <div id="copy-status" class="status-area"></div>
            <div id="results"></div>
        </div>
    </div>
    <script src="../js/data/quizData.js"></script>
    <script src="../js/utils/normalization.js"></script>
    <script src="../js/utils/helpers.js"></script>
    <script src="../js/utils/validation.js"></script>
    <script src="../js/state/learningState.js"></script>
    <script src="../js/utils/errorHandler.js"></script>
    <script src="../js/practice-menu.js"></script>
    <script>
        // Test Results Storage
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            tests: []
        };

        // Test Categories
        const TEST_CATEGORIES = {
            CORE: 'Core Logic',
            DATA: 'Data & Validation', 
            UI: 'UI & Integration',
            ADVANCED: 'Advanced Features',
            PERFORMANCE: 'Performance'
        };

        // Test Suite Definition
        const TEST_SUITE = {
            [TEST_CATEGORIES.CORE]: [
                {
                    name: 'Learning State Initialization',
                    category: TEST_CATEGORIES.CORE,
                    test: () => {
                        const state = window.learningState;
                        return {
                            passed: state && typeof state.currentChapterIndex === 'number',
                            details: `State initialized: ${!!state}, Chapter index: ${state?.currentChapterIndex}`
                        };
                    }
                },
                {
                    name: 'Question Generation',
                    category: TEST_CATEGORIES.CORE,
                    test: () => {
                        const question = window.generateQuestion();
                        return {
                            passed: question && question.questionText && question.expectedAnswer,
                            details: `Generated question: ${question?.questionText || 'null'}`
                        };
                    }
                },
                {
                    name: 'Level Progression',
                    category: TEST_CATEGORIES.CORE,
                    test: () => {
                        const level = window.getCurrentLevel();
                        return {
                            passed: level && level.chapters && level.keys,
                            details: `Current level: ${level?.name || 'null'}`
                        };
                    }
                },
                {
                    name: 'Skip Logic for C Major',
                    category: TEST_CATEGORIES.CORE,
                    test: () => {
                        // Test that C major skips accidentals naming
                        const originalState = { ...window.learningState };
                        window.learningState.currentKeyIndex = 0; // C major
                        window.learningState.currentChapterIndex = 1; // accNotes
                        
                        const question = window.generateQuestion();
                        const skipped = question.chapterId !== 'accNotes';
                        
                        // Restore state
                        window.learningState = originalState;
                        
                        return {
                            passed: skipped,
                            details: `C major skip logic: ${skipped ? 'working' : 'failed'}`
                        };
                    }
                }
            ],
            [TEST_CATEGORIES.DATA]: [
                {
                    name: 'Quiz Data Loading',
                    category: TEST_CATEGORIES.DATA,
                    test: () => {
                        return {
                            passed: window.quizData && Object.keys(window.quizData).length > 0,
                            details: `Loaded ${Object.keys(window.quizData || {}).length} keys`
                        };
                    }
                },
                {
                    name: 'Data Completeness',
                    category: TEST_CATEGORIES.DATA,
                    test: () => {
                        const keys = Object.keys(window.quizData || {});
                        let allComplete = true;
                        let missingData = [];
                        
                        keys.forEach(key => {
                            const keyData = window.quizData[key];
                            if (!keyData.scale || !keyData.triads || !keyData.sevenths) {
                                allComplete = false;
                                missingData.push(key);
                            }
                        });
                        
                        return {
                            passed: allComplete,
                            details: `Data complete: ${allComplete}, Missing: ${missingData.join(', ') || 'none'}`
                        };
                    }
                },
                {
                    name: 'Note Normalization',
                    category: TEST_CATEGORIES.DATA,
                    test: () => {
                        const testCases = [
                            { input: 'C#', expected: 'C♯' },
                            { input: 'Db', expected: 'D♭' },
                            { input: 'F##', expected: 'F𝄪' },
                            { input: 'Bbb', expected: 'B𝄫' }
                        ];
                        
                        let passed = 0;
                        let details = [];
                        
                        testCases.forEach(({ input, expected }) => {
                            const result = window.accidentalToUnicode(input);
                            const success = result === expected;
                            if (success) passed++;
                            details.push(`${input} → ${result} ${success ? '✓' : '✗'}`);
                        });
                        
                        return {
                            passed: passed === testCases.length,
                            details: details.join(', ')
                        };
                    }
                },
                {
                    name: 'Answer Validation',
                    category: TEST_CATEGORIES.DATA,
                    test: () => {
                        // Create a simple validateAnswer function for testing
                        const validateAnswer = (answer, expected) => {
                            if (!answer || !expected) return false;
                            const normalizedAnswer = answer.trim().toLowerCase().replace(/,/g, ' ');
                            const normalizedExpected = expected.trim().toLowerCase().replace(/,/g, ' ');
                            return normalizedAnswer === normalizedExpected;
                        };
                        
                        const testCases = [
                            { answer: 'C E G', expected: 'C E G', shouldPass: true },
                            { answer: 'C,E,G', expected: 'C E G', shouldPass: true },
                            { answer: 'C E G', expected: 'C F G', shouldPass: false }
                        ];
                        
                        let passed = 0;
                        let details = [];
                        
                        testCases.forEach(({ answer, expected, shouldPass }) => {
                            const result = validateAnswer(answer, expected);
                            const success = result === shouldPass;
                            if (success) passed++;
                            details.push(`${answer} vs ${expected}: ${result} ${success ? '✓' : '✗'}`);
                        });
                        
                        return {
                            passed: passed === testCases.length,
                            details: details.join(', ')
                        };
                    }
                }
            ],
            [TEST_CATEGORIES.UI]: [
                {
                    name: 'DOM Element Access',
                    category: TEST_CATEGORIES.UI,
                    test: () => {
                        const testElement = document.createElement('div');
                        testElement.id = 'test-element';
                        document.body.appendChild(testElement);
                        
                        const result = window.MusicTheoryHelpers.getElement('test-element');
                        document.body.removeChild(testElement);
                        
                        return {
                            passed: result && result.id === 'test-element',
                            details: `Element access: ${result ? 'working' : 'failed'}`
                        };
                    }
                },
                {
                    name: 'Helper Functions',
                    category: TEST_CATEGORIES.UI,
                    test: () => {
                        const testElement = document.createElement('div');
                        testElement.id = 'helper-test';
                        document.body.appendChild(testElement);
                        
                        let passed = 0;
                        const tests = [
                            () => { window.MusicTheoryHelpers.setElementText('helper-test', 'test'); return testElement.textContent === 'test'; },
                            () => { window.MusicTheoryHelpers.setElementClass('helper-test', 'test-class'); return testElement.className === 'test-class'; },
                            () => { window.MusicTheoryHelpers.setElementDisplay('helper-test', 'none'); return testElement.style.display === 'none'; }
                        ];
                        
                        tests.forEach(test => {
                            if (test()) passed++;
                        });
                        
                        document.body.removeChild(testElement);
                        
                        return {
                            passed: passed === tests.length,
                            details: `${passed}/${tests.length} helper functions working`
                        };
                    }
                }
            ],
            [TEST_CATEGORIES.ADVANCED]: [
                {
                    name: 'Seventh Chord Data',
                    category: TEST_CATEGORIES.ADVANCED,
                    test: () => {
                        const keys = Object.keys(window.quizData || {});
                        let allHaveSevenths = true;
                        let missingSevenths = [];
                        
                        keys.forEach(key => {
                            const keyData = window.quizData[key];
                            if (!keyData.sevenths || Object.keys(keyData.sevenths).length !== 7) {
                                allHaveSevenths = false;
                                missingSevenths.push(key);
                            }
                        });
                        
                        return {
                            passed: allHaveSevenths,
                            details: `Seventh chords complete: ${allHaveSevenths}, Missing: ${missingSevenths.join(', ') || 'none'}`
                        };
                    }
                },
                {
                    name: 'Chord Degree Validation',
                    category: TEST_CATEGORIES.ADVANCED,
                    test: () => {
                        const testKey = 'C';
                        const keyData = window.quizData[testKey];
                        let passed = 0;
                        let details = [];
                        
                        for (let degree = 1; degree <= 7; degree++) {
                            const triad = keyData.triads[degree.toString()];
                            const seventh = keyData.sevenths[degree.toString()];
                            
                            if (triad && seventh) {
                                passed++;
                                details.push(`Degree ${degree}: ✓`);
                            } else {
                                details.push(`Degree ${degree}: ✗`);
                            }
                        }
                        
                        return {
                            passed: passed === 7,
                            details: details.join(', ')
                        };
                    }
                }
            ],
            [TEST_CATEGORIES.PERFORMANCE]: [
                {
                    name: 'Question Generation Performance',
                    category: TEST_CATEGORIES.PERFORMANCE,
                    test: () => {
                        const start = performance.now();
                        let questions = [];
                        
                        for (let i = 0; i < 100; i++) {
                            questions.push(window.generateQuestion());
                        }
                        
                        const end = performance.now();
                        const duration = end - start;
                        
                        return {
                            passed: duration < 1000, // Should complete in under 1 second
                            details: `Generated 100 questions in ${duration.toFixed(2)}ms`
                        };
                    }
                },
                {
                    name: 'Data Access Performance',
                    category: TEST_CATEGORIES.PERFORMANCE,
                    test: () => {
                        const start = performance.now();
                        const keys = Object.keys(window.quizData || {});
                        
                        keys.forEach(key => {
                            const keyData = window.quizData[key];
                            // Access all properties
                            keyData.scale;
                            keyData.triads;
                            keyData.sevenths;
                            keyData.accidentals;
                            keyData.notes;
                        });
                        
                        const end = performance.now();
                        const duration = end - start;
                        
                        return {
                            passed: duration < 100, // Should complete in under 100ms
                            details: `Accessed all data in ${duration.toFixed(2)}ms`
                        };
                    }
                }
            ]
        };

        // Test Runner Functions
        function runAllTests() {
            const allTests = Object.values(TEST_SUITE).flat();
            runTestCategory('All Tests', allTests);
        }

        function runCoreTests() {
            runTestCategory(TEST_CATEGORIES.CORE, TEST_SUITE[TEST_CATEGORIES.CORE]);
        }

        function runDataTests() {
            runTestCategory(TEST_CATEGORIES.DATA, TEST_SUITE[TEST_CATEGORIES.DATA]);
        }

        function runUITests() {
            runTestCategory(TEST_CATEGORIES.UI, TEST_SUITE[TEST_CATEGORIES.UI]);
        }

        function runAdvancedTests() {
            runTestCategory(TEST_CATEGORIES.ADVANCED, TEST_SUITE[TEST_CATEGORIES.ADVANCED]);
        }

        function runPerformanceTests() {
            runTestCategory(TEST_CATEGORIES.PERFORMANCE, TEST_SUITE[TEST_CATEGORIES.PERFORMANCE]);
        }

        function runTestCategory(categoryName, tests) {
            // Reset results
            testResults = {
                total: tests.length,
                passed: 0,
                failed: 0,
                tests: [],
                category: categoryName,
                timestamp: new Date().toISOString()
            };

            // Show progress
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.className = 'progress-fill';
            progressText.textContent = `Running ${categoryName}...`;

            // Clear results area
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // Run tests
            let completed = 0;
            tests.forEach((test, index) => {
                setTimeout(() => {
                    try {
                        const result = test.test();
                        const testResult = {
                            name: test.name,
                            category: test.category,
                            passed: result.passed,
                            details: result.details,
                            timestamp: new Date().toISOString()
                        };

                        testResults.tests.push(testResult);
                        
                        if (result.passed) {
                            testResults.passed++;
                        } else {
                            testResults.failed++;
                        }

                        // Update progress
                        completed++;
                        const progress = (completed / tests.length) * 100;
                        progressFill.style.width = `${progress}%`;
                        
                        if (completed === tests.length) {
                            progressFill.className = 'progress-fill complete';
                            progressText.textContent = 'Tests completed!';
                        }

                        // Display result
                        displayTestResult(testResult);

                    } catch (error) {
                        const testResult = {
                            name: test.name,
                            category: test.category,
                            passed: false,
                            details: `Error: ${error.message}`,
                            timestamp: new Date().toISOString()
                        };

                        testResults.tests.push(testResult);
                        testResults.failed++;
                        completed++;

                        const progress = (completed / tests.length) * 100;
                        progressFill.style.width = `${progress}%`;
                        progressFill.className = 'progress-fill error';
                        progressText.textContent = 'Tests completed with errors!';

                        displayTestResult(testResult);
                    }
                }, index * 50); // Stagger test execution
            });

            // Display summary after all tests complete
            setTimeout(() => {
                displaySummary();
            }, tests.length * 50 + 100);
        }

        function displayTestResult(testResult) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${testResult.passed ? 'pass' : 'fail'}`;
            
            resultDiv.innerHTML = `
                <div class="status">${testResult.passed ? '✓ PASS' : '✗ FAIL'}: ${testResult.name}</div>
                <div class="test-details">${testResult.details}</div>
            `;
            
            resultsDiv.appendChild(resultDiv);
        }

        function displaySummary() {
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            const successRate = testResults.total > 0 ? ((testResults.passed / testResults.total) * 100).toFixed(1) : '0';
            
            summaryContent.innerHTML = `
                <h3>Test Summary: ${testResults.category}</h3>
                <p><strong>Total Tests:</strong> ${testResults.total}</p>
                <p><strong>Passed:</strong> ${testResults.passed}</p>
                <p><strong>Failed:</strong> ${testResults.failed}</p>
                <p><strong>Success Rate:</strong> ${successRate}%</p>
                <p><strong>Completed:</strong> ${new Date(testResults.timestamp).toLocaleString()}</p>
            `;
            
            summaryDiv.style.display = 'block';
        }

        function copyResults() {
            const resultsText = JSON.stringify(testResults, null, 2);
            navigator.clipboard.writeText(resultsText).then(() => {
                const statusDiv = document.getElementById('copy-status');
                statusDiv.textContent = 'Results copied to clipboard!';
                statusDiv.style.display = 'block';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }).catch(err => {
                console.error('Failed to copy results:', err);
                alert('Failed to copy results to clipboard');
            });
        }

        function clearResults() {
            testResults = {
                total: 0,
                passed: 0,
                failed: 0,
                tests: []
            };
            
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('copy-status').style.display = 'none';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Comprehensive test suite loaded');
            console.log('Available test categories:', Object.keys(TEST_SUITE));
        });
    </script>
</body>
</html> 