<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Seventh Chords</title>
    <link rel="stylesheet" href="css/test-suite.css">
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Test Suite</a>
        <div class="header">
            <h1>üéµ Seventh Chords</h1>
            <p>This test suite verifies seventh chord normalization and validation.</p>
        </div>
        <div class="content-box">
            <div id="summary" class="summary" style="display:none;">
                <div id="stats" class="stats-grid"></div>
            </div>
            <div class="controls">
                <button class="btn" onclick="runTests()">Run Tests</button>
                <button class="btn" onclick="copyResults()">Copy Results (JSON)</button>
            </div>
            <div id="results"></div>
            <div id="copy-status" class="status-area"></div>
        </div>
    </div>

    <script src="../js/data/quizData.js"></script>
    <script src="js/test-dashboard.js"></script>
    <script>
        const allKeys = Object.keys(quizData);
        const degrees = [2, 3, 4, 5, 6, 7];
        const degreeNames = ['ii', 'iii', 'IV', 'V', 'vi', 'vii¬∞'];

        function ordinal(n) {
            const s = ["th", "st", "nd", "rd"], v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = ''; // Clear previous results

            const testData = runSeventhChordTests();
            window._seventhsTestResults = testData; // Expose for export
            displayResults(testData);
        }

        function runSeventhChordTests() {
            const results = [];
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;

            allKeys.forEach(key => {
                const keyData = quizData[key];
                const keyResults = [];

                degrees.forEach((degree, index) => {
                    const chordName = keyData.sevenths[degree];
                    const spelling = keyData.seventhSpelling[degree];
                    const expectedSpelling = spelling.join(' ');
                    
                    // Test the spelling validation
                    const testResult = {
                        key: key,
                        degree: degree,
                        degreeName: degreeNames[index],
                        chordName: chordName,
                        expectedSpelling: expectedSpelling,
                        spellingArray: spelling,
                        passed: true, // We'll validate the data structure
                        notes: spelling
                    };

                    // Validate that the spelling has exactly 4 notes
                    if (spelling.length !== 4) {
                        testResult.passed = false;
                        testResult.error = `Expected 4 notes, got ${spelling.length}`;
                    }

                    // Validate that all notes are valid
                    const validNotes = [
                        'C', 'C#', 'Cb', 'Db', 'D', 'D#', 'Eb', 'E', 'E#', 'Fb', 'F', 'F#', 'Gb',
                        'G', 'G#', 'Ab', 'A', 'A#', 'Bb', 'B', 'B#',
                        // Unicode flat versions for completeness
                        'C‚ô≠', 'D‚ô≠', 'E‚ô≠', 'F‚ô≠', 'G‚ô≠', 'A‚ô≠', 'B‚ô≠'
                    ];
                    spelling.forEach(note => {
                        const normalizedNote = note.trim();
                        if (!validNotes.includes(normalizedNote)) {
                            testResult.passed = false;
                            testResult.error = `Invalid note: ${note} (char codes: ${[...note].map(c => c.charCodeAt(0)).join(',')})`;
                            console.warn(`Invalid note detected: '${note}' (normalized: '${normalizedNote}') in key ${key}, chord ${chordName}`);
                        }
                    });

                    // Validate chord name format
                    const validChordTypes = ['m7', 'maj7', '7', 'm7‚ô≠5'];
                    const chordType = chordName.replace(/^[A-G][#‚ôØb‚ô≠]?/, '');
                    if (!validChordTypes.includes(chordType)) {
                        testResult.passed = false;
                        testResult.error = `Invalid chord type: ${chordType}`;
                    }

                    keyResults.push(testResult);
                    totalTests++;
                    if (testResult.passed) {
                        passedTests++;
                    } else {
                        failedTests++;
                    }
                });

                results.push({
                    key: key,
                    results: keyResults
                });
            });

            return {
                results: results,
                stats: {
                    total: totalTests,
                    passed: passedTests,
                    failed: failedTests
                }
            };
        }

        function displayResults(testData) {
            const container = document.getElementById('results');
            const summary = document.getElementById('summary');
            const statsEl = document.getElementById('stats');
            container.innerHTML = ''; // Clear previous results

            // Display summary
            summary.style.display = 'block';
            const stats = testData.stats;
            const successRate = stats.total > 0 ? ((stats.passed / stats.total) * 100).toFixed(0) : 0;

            statsEl.innerHTML = `
                <p><strong>Total Tests:</strong> ${stats.total}</p>
                <p><strong>Passed:</strong> ${stats.passed} ‚úÖ</p>
                <p><strong>Failed:</strong> ${stats.failed} ‚ùå</p>
                <p><strong>Success Rate:</strong> ${successRate}%</p>
            `;

            // Save results to dashboard
            if (window.TestDashboard) {
                window.TestDashboard.saveTestResult('test_sevenths.html', {
                    total: stats.total,
                    passed: stats.passed,
                    failed: stats.failed,
                    successRate: successRate
                });
            }

            // Display detailed results
            container.innerHTML = ''; // Clear previous results
            testData.results.forEach(keyResult => {
                const keySection = document.createElement('div');
                keySection.className = 'test-category';
                
                const keyHeader = document.createElement('h3');
                keyHeader.textContent = `${keyResult.key} Major Sevenths`;
                keySection.appendChild(keyHeader);

                keyResult.results.forEach(test => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'test-result ' + (test.passed ? 'pass' : 'fail');
                    resultDiv.innerHTML = `
                        <strong>${test.degreeName} (${test.chordName})</strong><br>
                        Expected Spelling: ${test.expectedSpelling}<br>
                        Status: ${test.passed ? '‚úÖ PASS' : `‚ùå FAIL ${test.error ? `(${test.error})` : ''}`}
                    `;
                    keySection.appendChild(resultDiv);
                });

                container.appendChild(keySection);
            });
        }

        function copyResults() {
            if (!window._seventhsTestResults) {
                document.getElementById('copy-status').textContent = 'No results to copy. Run the tests first.';
                return;
            }
            const json = JSON.stringify(window._seventhsTestResults, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                document.getElementById('copy-status').textContent = 'Results copied to clipboard!';
            }, () => {
                document.getElementById('copy-status').textContent = 'Failed to copy results.';
            });
        }

        // document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html> 